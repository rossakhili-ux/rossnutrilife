<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Экспорт завтраков — Ross | NutriLife</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--ink:#111;--muted:#666;--bd:#e6e6e6}
    html,body{margin:0;padding:0;background:#fff;color:var(--ink);font:14px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif}
    header{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--bd);position:sticky;top:0;background:#fff;z-index:1}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fafafa;cursor:pointer}
    .btn.primary{background:#0a3811;color:#fff;border-color:#0a3811}
    .hint{color:var(--muted);font-size:12px}
    #content{padding:12px}
    @media print { header{display:none} #content{padding:0} }
  </style>
  <!-- Надёжный вариант: рендерим страницу в изображения и собираем PDF вручную (без шрифтов) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5lKQxCqvQn7C5J8wq8o17mU9rPzY9wYJmF0gQe0e2Qf3f1oWwI0pYfT5hW2Y5bQv8y7x9o0H1Sx7s8H+Gxw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-YkqkqfM9Q2w3Qq8R8p7mO5YpW1GxqC8aF4Cw6m2xS9xD8Kz2b1xgQKkKQ5N3yQGx1oQm1m9x3iU9Xb9Z3b9QxA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <header>
    <div>
      <strong>Экспорт завтраков</strong>
      <div class="hint">Если печать не сработает — скачайте PDF</div>
    </div>
    <div class="actions">
      <button class="btn" id="printBtn" type="button">Печать</button>
      <button class="btn primary" id="pdfBtn" type="button">Скачать PDF</button>
    </div>
  </header>

  <div id="content"></div>

  <script>
  (function(){
    function decodeFromHash(){
      try{
        const b64 = decodeURIComponent(location.hash.slice(1));
        if(!b64) return null;
        return atob(b64);
      }catch(e){ return null; }
    }
    function extractBody(html){
      try{
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        return doc.body.innerHTML || html;
      }catch(e){
        return html;
      }
    }

    const raw = decodeFromHash();
    if(!raw){
      document.getElementById('content').innerHTML = '<div style="padding:16px">Не удалось прочитать данные для печати.</div>';
      return;
    }
    document.getElementById('content').innerHTML = extractBody(raw);

    // 1) Кнопка печати (если поддерживается)
    function doPrint(){ setTimeout(function(){ try{ window.print(); }catch(e){} }, 150); }
    document.getElementById('printBtn').addEventListener('click', doPrint);

    // 2) Кнопка "Скачать PDF" — делаем PDF из картинок, шрифты не нужны
    async function downloadPDF(){
      try{
        const el = document.getElementById('content');
        const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
        const imgData = canvas.toDataURL('image/jpeg', 0.95);

        // Параметры A4 портрет
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 10;
        const usableWidth = pageWidth - margin*2;
        const usableHeight = pageHeight - margin*2;

        // соотношение сторон изображения
        const imgW = canvas.width;
        const imgH = canvas.height;
        const imgAspect = imgW / imgH;

        // масштабируем по ширине
        const renderWidth = usableWidth;
        const renderHeight = renderWidth / imgAspect;

        // если одна страница — просто рисуем
        if (renderHeight <= usableHeight){
          pdf.addImage(imgData, 'JPEG', margin, margin, renderWidth, renderHeight);
        } else {
          // разбиваем изображение на куски по высоте страницы
          const pageCount = Math.ceil(renderHeight / usableHeight);
          const sliceHeightPx = Math.floor(imgH / pageCount);
          for (let i=0; i<pageCount; i++){
            if (i>0) pdf.addPage();
            const sliceCanvas = document.createElement('canvas');
            sliceCanvas.width = imgW;
            sliceCanvas.height = sliceHeightPx;
            const ctx = sliceCanvas.getContext('2d');
            // источник: часть исходного canvas
            ctx.drawImage(canvas, 0, i*sliceHeightPx, imgW, sliceHeightPx, 0, 0, imgW, sliceHeightPx);
            const sliceData = sliceCanvas.toDataURL('image/jpeg', 0.95);
            const sliceHeightMm = (sliceCanvas.height / imgW) * renderWidth; // пропорциональная высота
            pdf.addImage(sliceData, 'JPEG', margin, margin, renderWidth, sliceHeightMm);
          }
        }

        pdf.save('Ross_NutriLife_breakfasts.pdf');
      }catch(e){
        console.error(e);
        alert('Не удалось сформировать PDF автоматически. Попробуйте «Печать» и сохранение в PDF.');
      }
    }
    document.getElementById('pdfBtn').addEventListener('click', downloadPDF);

    // Попытка автопечати
    window.addEventListener('load', function(){ setTimeout(doPrint, 300); }, { once:true });
  })();
  </script>
</body>
</html>
