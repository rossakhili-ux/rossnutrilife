<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Экспорт завтраков — Ross | NutriLife</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--ink:#111;--muted:#666;--bd:#e6e6e6}
    html,body{margin:0;padding:0;background:#fff;color:var(--ink);font:14px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif}
    header{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--bd);position:sticky;top:0;background:#fff;z-index:1}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fafafa;cursor:pointer}
    .btn.primary{background:#0a3811;color:#fff;border-color:#0a3811}
    .hint{color:var(--muted);font-size:12px}
    #content{padding:12px}
    @media print { header{display:none} #content{padding:0} }
  </style>
  <!-- Надёжный вариант: рендерим страницу в изображения и собираем PDF вручную (без шрифтов) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5lKQxCqvQn7C5J8wq8o17mU9rPzY9wYJmF0gQe0e2Qf3f1oWwI0pYfT5hW2Y5bQv8y7x9o0H1Sx7s8H+Gxw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-YkqkqfM9Q2w3Qq8R8p7mO5YpW1GxqC8aF4Cw6m2xS9xD8Kz2b1xgQKkKQ5N3yQGx1oQm1m9x3iU9Xb9Z3b9QxA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <header>
    <div>
      <strong>Экспорт завтраков</strong>
      <div class="hint">Если печать не сработает — скачайте PDF</div>
    </div>
    <div class="actions">
      <button class="btn" id="printBtn" type="button">Печать</button>
      <button class="btn primary" id="pdfBtn" type="button">Скачать PDF</button>
    </div>
  </header>

  <div id="content"></div>

  
<script>
/*! LZ-String (MIT) - compressToEncodedURIComponent/decompressFromEncodedURIComponent only */
var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={},e={compressToEncodedURIComponent:function(o){return null==o?"":e._compress(o,6,function(o){return n.charAt(o)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:e._decompress(r.length,32,function(t){return o(n,r.charAt(t))})},_compress:function(o,n,t){if(null==o)return"";var e,i,u={},c={},p="",a="",s="",l=2,f=3,h=2,d=[],m=0,v=0;for(i=0;i<o.length;i+=1)if(p=o.charAt(i),Object.prototype.hasOwnProperty.call(u,p)||(u[p]=f++,c[p]=!0),a=s+p,Object.prototype.hasOwnProperty.call(u,a))s=a;else{if(Object.prototype.hasOwnProperty.call(c,s)){if(s.charCodeAt(0)<256){for(e=0;e<h;e++)m<<=1,v==n-1?(v=0,d.push(t(m)),m=0):v++;for(i=s.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++,i>>=1}else{for(i=1,e=0;e<h;e++)m=m<<1|i,v==n-1?(v=0,d.push(t(m)),m=0):v++,i=0;for(i=s.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++,i>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete c[s]}else for(i=u[s],e=0;e<h;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++,i>>=1;l--,0==l&&(l=Math.pow(2,h),h++),u[a]=f++,s=String(p)}if(""!==s){if(Object.prototype.hasOwnProperty.call(c,s)){if(s.charCodeAt(0)<256){for(e=0;e<h;e++)m<<=1,v==n-1?(v=0,d.push(t(m)),m=0):v++;for(i=s.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++,i>>=1}else{for(i=1,e=0;e<h;e++)m=m<<1|i,v==n-1?(v=0,d.push(t(m)),m=0):v++,i=0;for(i=s.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++,i>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete c[s]}else for(i=u[s],e=0;e<h;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++,i>>=1;l--,0==l&&(l=Math.pow(2,h),h++),m<<=1,v==n-1?(v=0,d.push(t(m)),m=0):v++}for(i=0;i<h;i++)m=m<<1,v==n-1?(v=0,d.push(t(m)),m=0):v++;return d.push(t(m|1)),d.join("")},_decompress:function(o,n,t){var e,i,u,c,p,a,s,l,f=[],h=4,d=4,m=3,v="",w=[],A={val:t(0),position:n,index:1};for(i=0;i<3;i+=1)f[i]=i;for(c=0,p=Math.pow(2,2),a=1;a!=p;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),c|=(u>0?1:0)*a,a<<=1;switch(e=c){case 0:for(c=0,p=Math.pow(2,8),a=1;a!=p;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),c|=(u>0?1:0)*a,a<<=1;i=r(c);break;case 1:for(c=0,p=Math.pow(2,16),a=1;a!=p;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),c|=(u>0?1:0)*a,a<<=1;i=r(c);break;case 2:return""}for(f[3]=i,s=i,l=[],w.push(i);;){if(A.index>o)return"";for(c=0,p=Math.pow(2,m),a=1;a!=p;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),c|=(u>0?1:0)*a,a<<=1;switch(i=c){case 0:for(c=0,p=Math.pow(2,8),a=1;a!=p;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),c|=(u>0?1:0)*a,a<<=1;f[d++]=r(c),i=d-1,m--;break;case 1:for(c=0,p=Math.pow(2,16),a=1;a!=p;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),c|=(u>0?1:0)*a,a<<=1;f[d++]=r(c),i=d-1,m--;break;case 2:return w.join("")}if(0==m&&(m=Math.pow(2,++h)),f[i])v=f[i];else{if(i!==d)return null;v=s+s.charAt(0)}w.push(v),f[d++]=s+v.charAt(0),m--,s=v,0==m&&(m=Math.pow(2,++h))}
}};return e}();
</script>

<script>
  (function(){
    function decodeFromHash(){
      try{
        var enc = decodeURIComponent(location.hash.slice(1));
        if(!enc) return null;
        return LZString.decompressFromEncodedURIComponent(enc);
      }catch(e){ return null; }
    }
catch(e){ return null; }
    }
    function extractBody(html){
      try{
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        return doc.body.innerHTML || html;
      }catch(e){
        return html;
      }
    }

    const raw = decodeFromHash();
    if(!raw){
      document.getElementById('content').innerHTML = '<div style="padding:16px">Не удалось прочитать данные для печати.</div>';
      return;
    }
    document.getElementById('content').innerHTML = extractBody(raw);

    // 1) Кнопка печати (если поддерживается)
    function doPrint(){ setTimeout(function(){ try{ window.print(); }catch(e){} }, 150); }
    document.getElementById('printBtn').addEventListener('click', doPrint);

    // 2) Кнопка "Скачать PDF" — делаем PDF из картинок, шрифты не нужны
    async function downloadPDF(){
      try{
        const el = document.getElementById('content');
        const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
        const imgData = canvas.toDataURL('image/jpeg', 0.95);

        // Параметры A4 портрет
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 10;
        const usableWidth = pageWidth - margin*2;
        const usableHeight = pageHeight - margin*2;

        // соотношение сторон изображения
        const imgW = canvas.width;
        const imgH = canvas.height;
        const imgAspect = imgW / imgH;

        // масштабируем по ширине
        const renderWidth = usableWidth;
        const renderHeight = renderWidth / imgAspect;

        // если одна страница — просто рисуем
        if (renderHeight <= usableHeight){
          pdf.addImage(imgData, 'JPEG', margin, margin, renderWidth, renderHeight);
        } else {
          // разбиваем изображение на куски по высоте страницы
          const pageCount = Math.ceil(renderHeight / usableHeight);
          const sliceHeightPx = Math.floor(imgH / pageCount);
          for (let i=0; i<pageCount; i++){
            if (i>0) pdf.addPage();
            const sliceCanvas = document.createElement('canvas');
            sliceCanvas.width = imgW;
            sliceCanvas.height = sliceHeightPx;
            const ctx = sliceCanvas.getContext('2d');
            // источник: часть исходного canvas
            ctx.drawImage(canvas, 0, i*sliceHeightPx, imgW, sliceHeightPx, 0, 0, imgW, sliceHeightPx);
            const sliceData = sliceCanvas.toDataURL('image/jpeg', 0.95);
            const sliceHeightMm = (sliceCanvas.height / imgW) * renderWidth; // пропорциональная высота
            pdf.addImage(sliceData, 'JPEG', margin, margin, renderWidth, sliceHeightMm);
          }
        }

        pdf.save('Ross_NutriLife_breakfasts.pdf');
      }catch(e){
        console.error(e);
        alert('Не удалось сформировать PDF автоматически. Попробуйте «Печать» и сохранение в PDF.');
      }
    }
    document.getElementById('pdfBtn').addEventListener('click', downloadPDF);

    // Попытка автопечати
    window.addEventListener('load', function(){ setTimeout(doPrint, 300); }, { once:true });
  })();
  </script>
</body>
</html>
